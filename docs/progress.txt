Parley — Progress Log
=====================
Append a note here after completing each issue. Include: issue number, what was done, any gotchas or decisions made.

---

Issue #1 — Infrastructure & Hello World tracer (COMPLETE, 2026-02-20)

All infrastructure scaffolding was already in place:
- docker-compose.yml with 6 services (postgresql, temporal-admin-tools, temporal, temporal-ui, parley-worker, parley-api) on shared temporal-network bridge
- apps/worker/index.ts: NativeConnection + Worker on review-fast task queue, SIGTERM handler
- apps/worker/workflows/reviewWorkflow.ts: accepts { input }, runs echoActivity, sleeps 2s, exposes getReviewState query
- apps/worker/activities/mock.ts: echoActivity placeholder
- lib/db.ts: SQLite singleton with active_workflow table (single-row constraint enforces one-at-a-time)
- lib/temporal.ts: Temporal client singleton respecting TEMPORAL_ADDRESS env var
- POST /api/review/start: validates empty floor, starts workflow, stores row, returns workflowId (409 if already running)
- GET /api/review/stream: SSE endpoint polling getReviewState every 1s, emits floor-open when idle, clears DB on completion
- app/page.tsx: three-state UI (floor-open / running / complete) driven by EventSource SSE

Fix applied: tests/reviewWorkflow.test.ts used require.resolve('../apps/worker/workflows') which fails because Node's native resolver doesn't handle .ts files. Changed to path.resolve(__dirname, '../apps/worker/workflows') — Temporal's internal webpack bundler then handles TypeScript compilation. Both tests now pass.

pnpm typecheck: PASS
pnpm test: 2/2 PASS

---

Issue #2 — GitHub PR submission (COMPLETE, 2026-02-20)

New files:
- lib/github.ts: parseGitHubPRUrl (regex validates github.com/{owner}/{repo}/pull/{number}) + fetchPRFiles (calls GitHub public API, builds unified diff from file patches)
- apps/worker/activities/fetchGitHubPRDiff.ts: calls lib/github helpers, enforces 500-line cap via ApplicationFailure.nonRetryable, heartbeats during fetch. Retry policy: max 2 attempts, 1s backoff, 45s startToCloseTimeout, 15s heartbeatTimeout.

Changed files:
- apps/worker/workflows/reviewWorkflow.ts: input changed from { input: string } to { prUrl, context? }. First step fetches PR diff via proxyActivities, stores title/repoName/prNumber/diff in state. No sleep placeholder.
- apps/worker/index.ts: now imports fetchGitHubPRDiff activity instead of echoActivity.
- apps/api/app/api/review/start/route.ts: validates request body with zod schema, calls parseGitHubPRUrl for URL format check before starting workflow, passes { prUrl, context } to workflow.
- apps/api/app/api/review/stream/route.ts: updated query type to reflect new ReviewState shape.
- apps/api/app/page.tsx: replaced textarea with PR URL input + optional context textarea. Running state shows PR title/repo once fetched (or loading message before). Complete state shows PR title/repo.

Tests (16 total):
- tests/github.test.ts: 8 unit tests for parseGitHubPRUrl (valid URLs, invalid URLs, edge cases)
- tests/fetchGitHubPRDiff.test.ts: 5 tests mocking @temporalio/activity and lib/github — covers happy path, context passthrough, 500-line limit, correct call arguments
- tests/reviewWorkflow.test.ts: 3 workflow integration tests using TestWorkflowEnvironment with mock fetchGitHubPRDiff — covers PR metadata in state, context stored, sequential workflows

Gotchas:
- zod 4.3.6 was installed (latest). If AI SDK v6 in Issue #3 requires zod v3, may need to downgrade or use compatibility layer.
- @temporalio/activity heartbeat() throws if called outside activity context — mocked via vi.mock in unit tests.
- The vi.mock factory for @temporalio/activity manually implements ApplicationFailure.nonRetryable as a static method returning an Error subclass — this is sufficient for testing the throw/nonRetryable flag behavior.

pnpm typecheck: PASS
pnpm test: 16/16 PASS

---

Issue #3 — Parallel specialist agents (streaming) (COMPLETE, 2026-02-21)

New files:
- lib/models.ts: geminiFlashLite (gemini-2.5-flash-lite-preview-06-17) and geminiPro (gemini-2.5-pro) model configs via @ai-sdk/google. Read GEMINI_FAST_MODEL / GEMINI_DEEP_MODEL env vars.
- apps/worker/activities/specialists.ts: runIronjaw, runBarnacle, runGreenhand activities. Each uses streamText (no await, for live heartbeating of partial tokens) then generateText with Output.object for structured finding extraction. Finding IDs prefixed per persona (ironjaw-N, barnacle-N, greenhand-N). Prompts written in pirate first-person ship's log voice.
- tests/specialists.test.ts: 10 unit tests mocking ai SDK and @temporalio/activity — covers rawText accumulation, heartbeat calls, context passthrough, system prompt content, empty/null findings.
- tests/reviewWorkflowSpecialists.test.ts: 3 workflow integration tests — parallel dispatch stores all findings, query returns specialist status, context and diff pass through to specialists.

Changed files:
- apps/worker/workflows/reviewWorkflow.ts: added SpecialistState + specialists field to ReviewState. After fetchGitHubPRDiff, dispatches all three specialists via Promise.all, each wrapped in CancellationScope.withTimeout(45_000). Timed-out slots set to { status: 'timed-out', findings: null }. Join gate fires when all three resolve.
- apps/worker/index.ts: registers both fetchActivities and specialistActivities on the review-fast worker.
- apps/api/app/api/review/stream/route.ts: removed explicit query type annotation (spreads full ReviewState through).
- apps/api/app/page.tsx: added SpecialistDAG component using React Flow (@xyflow/react) with custom SpecialistNode components. Nodes show status color, attempt counter, streaming tokens while running, finding summary on completion.
- tests/reviewWorkflow.test.ts: added runIronjaw/runBarnacle/runGreenhand mocks to all three test workers (required since workflow now dispatches specialists).

Gotchas:
- AI SDK v6 text-delta chunks use part.text (not part.textDelta as in v5).
- zod v4 is compatible with ai SDK v6 peer dep (^3.25.76 || ^4.1.8).
- CancellationScope.withTimeout integration test with a forever-hanging mock activity cannot be tested in time-skipping env (activity runs in real time, only wf.sleep is skipped). The timeout behavior is tested via Temporal's own guarantees.
- streamText returns synchronously (no await) — call without await, then for-await over result.fullStream.

pnpm typecheck: PASS
pnpm test: 29/29 PASS

---

Issue #4 — Parallel challenge phase (Mutineer + human window + arbitration) (COMPLETE, 2026-02-21)

New files:
- apps/worker/activities/mutineer.ts: runMutineer activity — receives allFindings per specialist + capPerSpecialist, streams tokens via heartbeat (same pattern as specialists), then extracts structured challenges with generateText+Output.object. Returns { challenges: Array<{ findingId, specialistName, challengeText }> }.
- apps/worker/activities/arbitrator.ts: runArbitrator activity — receives { finding, mutineerChallenge?, humanChallenge? }, calls generateText+Output.object with a neutral ruling prompt. Returns { ruling: 'upheld'|'overturned'|'inconclusive', reasoning }. Falls back to upheld/inconclusive on null structured output.
- apps/api/app/api/review/extend/route.ts: POST /api/review/extend — sends extendReviewWindow Signal.
- apps/api/app/api/review/challenges/route.ts: POST /api/review/challenges — sends submitChallenges Update, returns { accepted: true }.
- tests/mutineer.test.ts: 7 unit tests (mock ai + @temporalio/activity).
- tests/arbitrator.test.ts: 7 unit tests.
- tests/reviewWorkflowChallenge.test.ts: 8 workflow integration tests for the challenge phase.

Changed files:
- apps/worker/workflows/reviewWorkflow.ts: Added ArbitrationState, MutineerStatus types. Extended ReviewState with windowOpen, secondsRemaining, humanChallenges, mutineerStatus, mutineerChallenges, arbitrations. Defined extendReviewWindow Signal + submitChallenges Update (registered EARLY, before any await, to avoid missed-handler errors). After Join Gate 1: opens window (600s), runs Mutineer in parallel (Join Gate 2). After Join Gate 2: merges Mutineer + human challenges per finding, fans out one runArbitrator per disputed finding in parallel. WINDOW_TICK_S=600 (single countdown iteration — fewest Temporal WFTs for tests).
- apps/worker/index.ts: registered mutineerActivities + arbitratorActivities on the review-fast worker.
- apps/api/app/page.tsx: Added MutineerPanel (streaming status + challenge count), HumanReviewPanel (countdown timer, per-finding textboxes, Extend/Submit buttons), ArbitrationPanel (ruling badges per finding). handleExtend and handleSubmitChallenges callbacks wired to new API routes.
- tests/reviewWorkflow.test.ts + reviewWorkflowSpecialists.test.ts: added mockMutineer + mockArbitrator to all workers (all registered activities required).

Gotchas:
- wf.setHandler TypeScript overload resolution: for UpdateDefinition<Ret, [Args]> the TS overloads can't match branded types. Fix: omit explicit handler parameter type (let TypeScript infer from the definition). Cannot use the options.validator parameter without hitting the same overload issue.
- Handler body throws → workflow-task failure + retry loop (not a proper update rejection). Root cause: a validator (options.validator) would reject properly, but the options argument triggers the TS overload bug. Fix: never throw in the handler body; instead, accept challenges at any point during 'running' status so the handler never needs to throw.
- Time-skipping race with executeUpdate: in TestWorkflowEnvironment.createTimeSkipping(), the 600s timer fires before the executeUpdate gRPC lands, so the update arrived when windowOpen=false, causing workflow-task failure (not update rejection). Fix: accept challenges regardless of windowOpen state. Timer-based window closure now happens naturally; challenges stored in humanChallenges regardless.
- Test isolation: shared TestWorkflowEnvironment caused cascade failures when one test timed out (stale worker references). Fix: each test creates and tears down its own TestWorkflowEnvironment via a withEnv() helper.
- Promise.all([executeUpdate, result()]): concurrent dispatch ensures both RPCs are in flight simultaneously, which is enough for normal delivery ordering.

pnpm typecheck: PASS
pnpm test: 51/51 PASS

---

Issue #5 — Synthesis, verdict, and run history (COMPLETE, 2026-02-20)

New files:
- apps/worker/activities/synthesis.ts: runSynthesis activity — receives specialistOutputs (Record<string, Finding[]|null>) + arbitrationOutcomes (Array<{findingId, ruling, reasoning}>). Streams tokens via heartbeat (geminiPro streamText), then calls generateText+Output.object for structured SynthesisVerdict { findings[], summary }. Runs on review-deep task queue.
- apps/worker/activities/history.ts: writeHistoryRecord activity — inserts completed review into SQLite reviews table. Receives { workflowId, prUrl, prTitle, repoName, prNumber, startedAt, completedAt, verdict }. Runs on fast queue (no taskQueue override).
- apps/api/app/api/review/history/route.ts: GET /api/review/history?offset=N — returns paginated review summaries (id, workflowId, prUrl, prTitle, repoName, prNumber, startedAt, completedAt, findingCount).
- apps/api/app/api/review/history/[id]/route.ts: GET /api/review/history/[id] — returns full review record including parsed verdict JSON.
- tests/synthesis.test.ts: 6 unit tests for runSynthesis (mock ai SDK + @temporalio/activity).
- tests/reviewWorkflowSynthesis.test.ts: 4 workflow integration tests for synthesis + history.

Changed files:
- lib/db.ts: added reviews table (CREATE TABLE IF NOT EXISTS) to getDb(). Added insertReview(), getReviewList(), getReviewById() helpers. findingCount computed via json_array_length(json_extract(verdict, '$.findings')).
- apps/worker/index.ts: now creates TWO workers — fastWorker on review-fast (all activities except synthesis), deepWorker on review-deep (synthesis only). Both run via Promise.all.
- apps/worker/workflows/reviewWorkflow.ts: added synthesisStatus ('idle'|'running'|'complete'|'failed'), synthesisPartialOutput, verdict to ReviewState. After arbitrations: waits for wf.allHandlersFinished, calls runSynthesis on review-deep via proxyActivities({ taskQueue: 'review-deep' }), then calls writeHistoryRecord. Both wrapped in try/catch — failures are non-fatal.
- apps/api/app/page.tsx: added SynthesisPanel (streaming text while running, grouped verdict findings on complete), VerdictFindingList (ruling badges + challenge source tags), HistoryModal (paginated list from /api/review/history), PastReviewPanel (static read-only view). Download JSON button on complete reviews.
- tests/reviewWorkflow.test.ts, reviewWorkflowSpecialists.test.ts, reviewWorkflowChallenge.test.ts: all updated to use withWorkers helper that creates both fast + review-deep workers. Added mockSynthesis and mockWriteHistory to all test workers. Required because workflow now dispatches to review-deep — tests hung without a deep worker registered.

Gotchas:
- Two-worker test pattern: start deepWorker.run() in background, await fastWorker.runUntil(fn), then deepWorker.shutdown() + await deepRun.catch(() => {}) in finally. This is the correct shutdown sequence for tests.
- wf.workflowInfo().startTime is deterministic in Temporal (part of workflow execution context) — safe to use for startedAt without worrying about replay non-determinism.
- wf.condition(wf.allHandlersFinished): must await this before calling synthesis to ensure all signal/update handlers (including submitChallenges) have completed.
- getReviewList uses json_array_length(json_extract(...)) for findingCount — avoids parsing JSON in TypeScript for a summary-only query.

pnpm typecheck: PASS
pnpm test: 62/62 PASS

---

Issue #6 — Educational layer, pirate personas, Continue-As-New, polish (COMPLETE, 2026-02-21)

New files:
- apps/api/app/globals.css: Added @keyframes fadeInUp and slideInRight for arbitrator node entrance animations and the WhyDrawer slide-in.

Changed files:
- apps/worker/workflows/reviewWorkflow.ts: Added `_resumeState?: ReviewState` to workflow args (optional, backward-compatible). Added `CAN_THRESHOLD = 10_000` and three Continue-As-New checkpoints (post-specialists, post-challenge, post-arbitrations). Refactored arbitrator fan-out to derive merge map from `state.mutineerChallenges` + `state.humanChallenges` (instead of local `mutineerResult`) so it's resume-safe. Added phase-skip guards: `if (!state.diff)` for Step 1, `if (!specialistsDone())` for Step 2, `if (!challengePhaseDone())` for Step 3. Arbitration slots initialized before CAN checkpoint 2 so resumed executions find populated slots.

- apps/api/app/page.tsx:
  - WHY_COPY constant: hand-written educational copy for 8 node types.
  - WhyDrawer component: fixed right-side overlay with slideInRight animation.
  - WhyBtn component: small "?" button wired to specialist nodes (React Flow onNodeClick), Mutineer panel, Extend Signal button, Submit Challenges Update button, Arbitrator panel, Synthesis panel.
  - EventLog component: semantic event labels tracked client-side via useEffect on state transitions. No raw Temporal event type names.
  - Persona polish: BARNACLE description fixed to "20-year greybeard." Arbitrator cards show "SPECIALIST's finding" from finding ID prefix. Verdict findings show specialist name in uppercase.
  - CSS transitions: `transition-all duration-300` on all status-colored borders. `animate-fade-in-up` on new arbitration cards. Streaming text retains blinking cursor (animate-pulse ▋).

Gotchas:
- Continue-As-New is verified by compilation only — TestWorkflowEnvironment never produces historyLength > 10_000. The phase-skip logic (specialistsDone, challengePhaseDone, synthesisStatus check) is structured for correct production behavior.
- `wf.continueAsNew<typeof reviewWorkflow>()` returns Promise<never>; no return needed after the await.
- React Flow onNodeClick signature: (event, node) — whyKey is read from node.data in the callback.

pnpm typecheck: PASS
pnpm test: 62/62 PASS

